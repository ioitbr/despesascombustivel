<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha Semanal de Despesas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .btn-add {
            background: #4CAF50;
            color: white;
        }
        
        .btn-add:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .btn-save {
            background: #2196F3;
            color: white;
        }
        
        .btn-save:hover {
            background: #0b7dda;
            transform: translateY(-2px);
        }

        .btn-clear {
            background: #FF9800;
            color: white;
        }

        .btn-clear:hover {
            background: #F57C00;
            transform: translateY(-2px);
        }
        
        .semana {
            margin-bottom: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            background: #f9f9f9;
        }
        
        .semana-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .datas-semana {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .datas-semana label {
            font-weight: 600;
            color: #667eea;
        }

        .datas-semana input[type="date"] {
            padding: 8px 12px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
        }

        .semana-header h3 {
            color: #667eea;
            font-size: 1.5em;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn-remove {
            background: #f44336;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-remove:hover {
            background: #da190b;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            font-size: 13px;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 6px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
        }
        
        td {
            padding: 8px 5px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        
        input[type="number"] {
            width: 70px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            text-align: right;
        }
        
        input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        .total-row {
            background: #e8eaf6 !important;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .total-row td {
            border-bottom: none;
        }
        
        .dia-col {
            font-weight: bold;
            background: #f5f5f5;
            width: 70px;
        }

        /* Se√ß√£o de C√°lculo de Combust√≠vel */
        .calculo-combustivel {
            background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 100%);
            color: #333;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .calculo-combustivel h4 {
            margin-bottom: 20px;
            font-size: 1.3em;
            color: #333;
        }

        .combustivel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .combustivel-item {
            background: rgba(255,255,255,0.9);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #333;
        }

        .combustivel-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .combustivel-item input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        .combustivel-item .valor-calculado {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-top: 5px;
        }
        
        .resumo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .resumo h4 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .resumo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .resumo-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
        }
        
        .resumo-item strong {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .resumo-item span {
            font-size: 1.5em;
            font-weight: bold;
        }

        .total-geral-destaque {
            background: rgba(255,255,255,0.3) !important;
            border: 3px solid white;
        }

        .status-salvo {
            text-align: center;
            color: #4CAF50;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Planilha Semanal de Despesas</h1>
        
        <div class="status-salvo" id="statusSalvo">‚úÖ Dados salvos automaticamente</div>
        
        <div class="buttons">
            <button class="btn-add" onclick="adicionarSemana()">‚ûï Nova Semana</button>
            <button class="btn-save" onclick="salvarExcel()">üíæ Salvar em Excel</button>
            <button class="btn-clear" onclick="limparTodosDados()">üóëÔ∏è Limpar Tudo</button>
        </div>
        
        <div id="semanas"></div>
        
        <!-- Se√ß√£o de C√°lculo de Combust√≠vel -->
        <div class="calculo-combustivel">
            <h4>‚õΩ C√ÅLCULO DE COMBUST√çVEL</h4>
            <div class="combustivel-grid">
                <div class="combustivel-item">
                    <label>TOTAL KM:</label>
                    <div class="valor-calculado" id="totalKmGeral">0 km</div>
                </div>
                <div class="combustivel-item">
                    <label>KM / LITRO:</label>
                    <input type="number" id="kmPorLitro" step="0.1" min="0" placeholder="Ex: 10" oninput="calcularCombustivel(); salvarDados();">
                </div>
                <div class="combustivel-item">
                    <label>VALOR COMBUST√çVEL (R$/L):</label>
                    <input type="number" id="valorCombustivel" step="0.01" min="0" placeholder="Ex: 4,13" oninput="calcularCombustivel(); salvarDados();">
                </div>
                <div class="combustivel-item">
                    <label>TOTAL EM LITROS:</label>
                    <div class="valor-calculado" id="totalLitros">0 L</div>
                </div>
                <div class="combustivel-item">
                    <label>TOTAL COMBUST√çVEL:</label>
                    <div class="valor-calculado" id="totalCombustivel" style="color: #f44336;">R$ 0,00</div>
                </div>
            </div>
        </div>

        <div class="resumo">
            <h4>üìä RESUMO GERAL</h4>
            <div class="resumo-grid">
                <div class="resumo-item">
                    <strong>Total Metr√¥/Bus:</strong>
                    <span id="totalMetroBus">R$ 0,00</span>
                </div>
                <div class="resumo-item">
                    <strong>Total Almo√ßo:</strong>
                    <span id="totalAlmoco">R$ 0,00</span>
                </div>
                <div class="resumo-item">
                    <strong>Despesas + Zona Azul:</strong>
                    <span id="totalDespesasZonal">R$ 0,00</span>
                </div>
                <div class="resumo-item">
                    <strong>Total Combust√≠vel:</strong>
                    <span id="resumoTotalCombustivel">R$ 0,00</span>
                </div>
                <div class="resumo-item total-geral-destaque">
                    <strong>TOTAL GERAL DE DESPESAS NA SEMANA:</strong>
                    <span id="totalGeralSemana" style="font-size: 2em;">R$ 0,00</span>
                </div>
                <div class="resumo-item">
                    <strong>M√©dia por Dia:</strong>
                    <span id="mediaDia">R$ 0,00</span>
                </div>
                <div class="resumo-item">
                    <strong>Total de Semanas:</strong>
                    <span id="totalSemanas">0</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let contadorSemanas = 0;
        const diasSemana = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];

        // Fun√ß√£o para salvar dados no LocalStorage
        function salvarDados() {
            const dados = {
                semanas: [],
                kmPorLitro: document.getElementById('kmPorLitro').value,
                valorCombustivel: document.getElementById('valorCombustivel').value,
                contadorSemanas: contadorSemanas
            };

            // Coletar dados de cada semana
            document.querySelectorAll('.semana').forEach(semana => {
                const semanaId = semana.id.split('-')[1];
                const dataInicio = semana.querySelector('.data-inicio').value;
                const dataFim = semana.querySelector('.data-fim').value;
                
                const dadosSemana = {
                    id: semanaId,
                    dataInicio: dataInicio,
                    dataFim: dataFim,
                    dias: []
                };

                // Coletar dados de cada dia
                diasSemana.forEach((dia, index) => {
                    const inputs = semana.querySelectorAll(`input[data-dia="${index}"]`);
                    const dadosDia = {
                        local1: inputs[0]?.value || '',
                        mb1: inputs[1]?.value || '',
                        km1: inputs[2]?.value || '',
                        local2: inputs[3]?.value || '',
                        mb2: inputs[4]?.value || '',
                        km2: inputs[5]?.value || '',
                        local3: inputs[6]?.value || '',
                        mb3: inputs[7]?.value || '',
                        km3: inputs[8]?.value || '',
                        almoco: inputs[9]?.value || '',
                        zonal: inputs[10]?.value || '',
                        desp: inputs[11]?.value || ''
                    };
                    dadosSemana.dias.push(dadosDia);
                });

                dados.semanas.push(dadosSemana);
            });

            localStorage.setItem('planilhaDespesas', JSON.stringify(dados));
            mostrarStatusSalvo();
        }

        // Fun√ß√£o para carregar dados do LocalStorage
        function carregarDados() {
            const dadosSalvos = localStorage.getItem('planilhaDespesas');
            
            if (!dadosSalvos) {
                // Se n√£o h√° dados salvos, adiciona primeira semana
                adicionarSemana();
                return;
            }

            const dados = JSON.parse(dadosSalvos);
            contadorSemanas = dados.contadorSemanas || 0;

            // Restaurar valores de combust√≠vel
            if (dados.kmPorLitro) {
                document.getElementById('kmPorLitro').value = dados.kmPorLitro;
            }
            if (dados.valorCombustivel) {
                document.getElementById('valorCombustivel').value = dados.valorCombustivel;
            }

            // Restaurar semanas
            dados.semanas.forEach(semanaData => {
                adicionarSemanaComDados(semanaData);
            });

            calcularTotais();
        }

        // Fun√ß√£o para adicionar semana com dados salvos
        function adicionarSemanaComDados(semanaData) {
            const semanasDiv = document.getElementById('semanas');
            const semanaDiv = document.createElement('div');
            semanaDiv.className = 'semana';
            semanaDiv.id = `semana-${semanaData.id}`;
            
            let tabelaHTML = `
                <div class="semana-header">
                    <div class="datas-semana">
                        <label>üóìÔ∏è De:</label>
                        <input type="date" class="data-inicio" value="${semanaData.dataInicio}" onchange="atualizarTituloSemana(this); salvarDados();" data-semana="${semanaData.id}">
                        <label>at√©:</label>
                        <input type="date" class="data-fim" value="${semanaData.dataFim}" onchange="atualizarTituloSemana(this); salvarDados();" data-semana="${semanaData.id}">
                    </div>
                    <button class="btn-remove" onclick="removerSemana(${semanaData.id})">üóëÔ∏è Remover</button>
                    <h3 id="titulo-semana-${semanaData.id}">üóìÔ∏è Semana de ${formatarData(semanaData.dataInicio)} a ${formatarData(semanaData.dataFim)}</h3>
                </div>
                <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">Dia</th>
                            <th colspan="3">Trajeto 1</th>
                            <th colspan="3">Trajeto 2</th>
                            <th colspan="3">Trajeto 3</th>
                            <th rowspan="2">Almo√ßo</th>
                            <th rowspan="2">Z.Azul</th>
                            <th rowspan="2">Desp.</th>
                            <th rowspan="2">Total</th>
                        </tr>
                        <tr>
                            <th>Local</th>
                            <th>M/B</th>
                            <th>KM</th>
                            <th>Local</th>
                            <th>M/B</th>
                            <th>KM</th>
                            <th>Local</th>
                            <th>M/B</th>
                            <th>KM</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            diasSemana.forEach((dia, index) => {
                const dadosDia = semanaData.dias[index] || {};
                tabelaHTML += `
                    <tr>
                        <td class="dia-col"><strong>${dia}</strong></td>
                        <td><input type="text" placeholder="Local" value="${dadosDia.local1}" data-semana="${semanaData.id}" data-dia="${index}" oninput="salvarDados()"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" value="${dadosDia.mb1}" class="valor" data-semana="${semanaData.id}" data-dia="${index}" data-col="mb1" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" value="${dadosDia.km1}" class="valor" data-semana="${semanaData.id}" data-dia="${index}" data-col="km1" data-tipo="km" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="text" placeholder="Local" value="${dadosDia.local2}" data-semana="${semanaData.id}" data-dia="${index}" oninput="salvarDados()"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" value="${dadosDia.mb2}" class="valor" data-semana="${semanaData.id}" data-dia="${index}" data-col="mb2" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" value="${dadosDia.km2}" class="valor" data-semana="${semanaData.id}" data-dia="${index}" data-col="km2" data-tipo="km" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="text" placeholder="Local" value="${dadosDia.local3}" data-semana="${semanaData.id}" data-dia="${index}" oninput="salvarDados()"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" value="${dadosDia.mb3}" class="valor" data-semana="${semanaData.id}" data-dia="${index}" data-col="mb3" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" value="${dadosDia.km3}" class="valor" data-semana="${semanaData.id}" data-dia="${index}" data-col="km3" data-tipo="km" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" value="${dadosDia.almoco}" class="valor" data-semana="${semanaData.id}" data-dia="${index}" data-col="almoco" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" value="${dadosDia.zonal}" class="valor" data-semana="${semanaData.id}" data-dia="${index}" data-col="zonal" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" value="${dadosDia.desp}" class="valor" data-semana="${semanaData.id}" data-dia="${index}" data-col="desp" oninput="calcularTotais(); salvarDados();"></td>
                        <td><strong><span id="total-dia-${semanaData.id}-${index}">R$ 0,00</span></strong></td>
                    </tr>
                `;
            });
            
            tabelaHTML += `
                    <tr class="total-row">
                        <td><strong>TOTAL</strong></td>
                        <td>-</td>
                        <td><strong><span id="total-mb1-${semanaData.id}">R$ 0</span></strong></td>
                        <td><strong><span id="total-km1-${semanaData.id}">0 km</span></strong></td>
                        <td>-</td>
                        <td><strong><span id="total-mb2-${semanaData.id}">R$ 0</span></strong></td>
                        <td><strong><span id="total-km2-${semanaData.id}">0 km</span></strong></td>
                        <td>-</td>
                        <td><strong><span id="total-mb3-${semanaData.id}">R$ 0</span></strong></td>
                        <td><strong><span id="total-km3-${semanaData.id}">0 km</span></strong></td>
                        <td><strong><span id="total-almoco-${semanaData.id}">R$ 0</span></strong></td>
                        <td><strong><span id="total-zonal-${semanaData.id}">R$ 0</span></strong></td>
                        <td><strong><span id="total-desp-${semanaData.id}">R$ 0</span></strong></td>
                        <td><strong><span id="total-semana-${semanaData.id}">R$ 0,00</span></strong></td>
                    </tr>
                </tbody>
            </table>
            </div>
            `;
            
            semanaDiv.innerHTML = tabelaHTML;
            semanasDiv.appendChild(semanaDiv);
        }

        function mostrarStatusSalvo() {
            const status = document.getElementById('statusSalvo');
            status.style.color = '#4CAF50';
            status.textContent = '‚úÖ Dados salvos automaticamente';
            
            setTimeout(() => {
                status.style.color = '#999';
            }, 2000);
        }

        function limparTodosDados() {
            if (confirm('‚ö†Ô∏è Tem certeza que deseja limpar TODOS os dados? Esta a√ß√£o n√£o pode ser desfeita!')) {
                localStorage.removeItem('planilhaDespesas');
                location.reload();
            }
        }

        function formatarData(data) {
            if (!data) return '';
            const partes = data.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        function atualizarTituloSemana(input) {
            const semana = input.closest('.semana');
            const semanaId = semana.id.split('-')[1];
            const dataInicio = semana.querySelector('.data-inicio').value;
            const dataFim = semana.querySelector('.data-fim').value;
            const titulo = semana.querySelector(`#titulo-semana-${semanaId}`);
            
            if (dataInicio && dataFim) {
                titulo.textContent = `üóìÔ∏è Semana de ${formatarData(dataInicio)} a ${formatarData(dataFim)}`;
            } else if (dataInicio) {
                titulo.textContent = `üóìÔ∏è Semana de ${formatarData(dataInicio)}`;
            } else {
                titulo.textContent = `üóìÔ∏è Semana ${semanaId}`;
            }
        }

        function adicionarSemana() {
            contadorSemanas++;
            const semanasDiv = document.getElementById('semanas');
            
            const semanaDiv = document.createElement('div');
            semanaDiv.className = 'semana';
            semanaDiv.id = `semana-${contadorSemanas}`;
            
            // Data de hoje para sugerir in√≠cio
            const hoje = new Date();
            const dataHoje = hoje.toISOString().split('T')[0];
            
            // Data final sugerida (6 dias depois)
            const dataFinal = new Date(hoje);
            dataFinal.setDate(dataFinal.getDate() + 6);
            const dataFinalStr = dataFinal.toISOString().split('T')[0];
            
            let tabelaHTML = `
                <div class="semana-header">
                    <div class="datas-semana">
                        <label>üóìÔ∏è De:</label>
                        <input type="date" class="data-inicio" value="${dataHoje}" onchange="atualizarTituloSemana(this); salvarDados();" data-semana="${contadorSemanas}">
                        <label>at√©:</label>
                        <input type="date" class="data-fim" value="${dataFinalStr}" onchange="atualizarTituloSemana(this); salvarDados();" data-semana="${contadorSemanas}">
                    </div>
                    <button class="btn-remove" onclick="removerSemana(${contadorSemanas})">üóëÔ∏è Remover</button>
                    <h3 id="titulo-semana-${contadorSemanas}">üóìÔ∏è Semana de ${formatarData(dataHoje)} a ${formatarData(dataFinalStr)}</h3>
                </div>
                <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2">Dia</th>
                            <th colspan="3">Trajeto 1</th>
                            <th colspan="3">Trajeto 2</th>
                            <th colspan="3">Trajeto 3</th>
                            <th rowspan="2">Almo√ßo</th>
                            <th rowspan="2">Z.Azul</th>
                            <th rowspan="2">Desp.</th>
                            <th rowspan="2">Total</th>
                        </tr>
                        <tr>
                            <th>Local</th>
                            <th>M/B</th>
                            <th>KM</th>
                            <th>Local</th>
                            <th>M/B</th>
                            <th>KM</th>
                            <th>Local</th>
                            <th>M/B</th>
                            <th>KM</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            diasSemana.forEach((dia, index) => {
                tabelaHTML += `
                    <tr>
                        <td class="dia-col"><strong>${dia}</strong></td>
                        <td><input type="text" placeholder="Local" data-semana="${contadorSemanas}" data-dia="${index}" oninput="salvarDados()"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" class="valor" data-semana="${contadorSemanas}" data-dia="${index}" data-col="mb1" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" class="valor" data-semana="${contadorSemanas}" data-dia="${index}" data-col="km1" data-tipo="km" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="text" placeholder="Local" data-semana="${contadorSemanas}" data-dia="${index}" oninput="salvarDados()"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" class="valor" data-semana="${contadorSemanas}" data-dia="${index}" data-col="mb2" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" class="valor" data-semana="${contadorSemanas}" data-dia="${index}" data-col="km2" data-tipo="km" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="text" placeholder="Local" data-semana="${contadorSemanas}" data-dia="${index}" oninput="salvarDados()"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" class="valor" data-semana="${contadorSemanas}" data-dia="${index}" data-col="mb3" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" class="valor" data-semana="${contadorSemanas}" data-dia="${index}" data-col="km3" data-tipo="km" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" class="valor" data-semana="${contadorSemanas}" data-dia="${index}" data-col="almoco" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" class="valor" data-semana="${contadorSemanas}" data-dia="${index}" data-col="zonal" oninput="calcularTotais(); salvarDados();"></td>
                        <td><input type="number" step="0.01" min="0" placeholder="0" class="valor" data-semana="${contadorSemanas}" data-dia="${index}" data-col="desp" oninput="calcularTotais(); salvarDados();"></td>
                        <td><strong><span id="total-dia-${contadorSemanas}-${index}">R$ 0,00</span></strong></td>
                    </tr>
                `;
            });
            
            tabelaHTML += `
                    <tr class="total-row">
                        <td><strong>TOTAL</strong></td>
                        <td>-</td>
                        <td><strong><span id="total-mb1-${contadorSemanas}">R$ 0</span></strong></td>
                        <td><strong><span id="total-km1-${contadorSemanas}">0 km</span></strong></td>
                        <td>-</td>
                        <td><strong><span id="total-mb2-${contadorSemanas}">R$ 0</span></strong></td>
                        <td><strong><span id="total-km2-${contadorSemanas}">0 km</span></strong></td>
                        <td>-</td>
                        <td><strong><span id="total-mb3-${contadorSemanas}">R$ 0</span></strong></td>
                        <td><strong><span id="total-km3-${contadorSemanas}">0 km</span></strong></td>
                        <td><strong><span id="total-almoco-${contadorSemanas}">R$ 0</span></strong></td>
                        <td><strong><span id="total-zonal-${contadorSemanas}">R$ 0</span></strong></td>
                        <td><strong><span id="total-desp-${contadorSemanas}">R$ 0</span></strong></td>
                        <td><strong><span id="total-semana-${contadorSemanas}">R$ 0,00</span></strong></td>
                    </tr>
                </tbody>
            </table>
            </div>
            `;
            
            semanaDiv.innerHTML = tabelaHTML;
            semanasDiv.appendChild(semanaDiv);
            calcularTotais();
            salvarDados();
        }

        function removerSemana(id) {
            const semana = document.getElementById(`semana-${id}`);
            if (semana && confirm('Tem certeza que deseja remover esta semana?')) {
                semana.remove();
                calcularTotais();
                salvarDados();
            }
        }

        function calcularTotais() {
            let totalGeralDinheiro = 0;
            let totalKmGlobal = 0;
            let totalMetroBusGlobal = 0;
            let totalAlmocoGlobal = 0;
            let totalDespesasZonalGlobal = 0;
            
            const semanas = document.querySelectorAll('.semana');
            
            semanas.forEach(semana => {
                const semanaId = semana.id.split('-')[1];
                let totalSemana = 0;
                
                // Colunas a calcular
                const colunas = ['mb1', 'km1', 'mb2', 'km2', 'mb3', 'km3', 'almoco', 'zonal', 'desp'];
                
                // Calcular totais por coluna
                colunas.forEach(col => {
                    let totalColuna = 0;
                    const inputs = semana.querySelectorAll(`input[data-col="${col}"]`);
                    
                    inputs.forEach(input => {
                        const valor = parseFloat(input.value) || 0;
                        totalColuna += valor;
                    });
                    
                    const spanCol = document.getElementById(`total-${col}-${semanaId}`);
                    if (spanCol) {
                        // Se for coluna KM, mostrar como n√∫mero + "km"
                        if (col.startsWith('km')) {
                            spanCol.textContent = `${totalColuna.toFixed(1)} km`;
                            totalKmGlobal += totalColuna;
                        } else {
                            spanCol.textContent = `R$ ${totalColuna.toFixed(2).replace('.', ',')}`;
                        }
                    }
                    
                    // Adicionar ao total da semana apenas valores monet√°rios
                    if (!col.startsWith('km')) {
                        totalSemana += totalColuna;
                        
                        // Somar para os totais globais espec√≠ficos
                        if (col.startsWith('mb')) {
                            totalMetroBusGlobal += totalColuna;
                        } else if (col === 'almoco') {
                            totalAlmocoGlobal += totalColuna;
                        } else if (col === 'zonal' || col === 'desp') {
                            totalDespesasZonalGlobal += totalColuna;
                        }
                    }
                });
                
                // Calcular totais por dia (apenas valores monet√°rios, sem KM)
                diasSemana.forEach((dia, index) => {
                    let totalDia = 0;
                    colunas.forEach(col => {
                        const input = semana.querySelector(`input[data-dia="${index}"][data-col="${col}"]`);
                        if (input && !col.startsWith('km')) {
                            totalDia += parseFloat(input.value) || 0;
                        }
                    });
                    const spanDia = document.getElementById(`total-dia-${semanaId}-${index}`);
                    if (spanDia) {
                        spanDia.textContent = `R$ ${totalDia.toFixed(2).replace('.', ',')}`;
                    }
                });
                
                // Total da semana (sem combust√≠vel ainda)
                const spanSemana = document.getElementById(`total-semana-${semanaId}`);
                if (spanSemana) {
                    spanSemana.textContent = `R$ ${totalSemana.toFixed(2).replace('.', ',')}`;
                }
                
                totalGeralDinheiro += totalSemana;
            });
            
            // Atualizar Total KM Global
            document.getElementById('totalKmGeral').textContent = `${totalKmGlobal.toFixed(1)} km`;
            
            // Calcular combust√≠vel
            calcularCombustivel();
            
            // Atualizar resumo por categoria
            document.getElementById('totalMetroBus').textContent = `R$ ${totalMetroBusGlobal.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalAlmoco').textContent = `R$ ${totalAlmocoGlobal.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalDespesasZonal').textContent = `R$ ${totalDespesasZonalGlobal.toFixed(2).replace('.', ',')}`;
            
            // Atualizar total de semanas
            const numSemanas = semanas.length;
            document.getElementById('totalSemanas').textContent = numSemanas;
        }

        function calcularCombustivel() {
            const totalKm = parseFloat(document.getElementById('totalKmGeral').textContent.replace(' km', '').replace(',', '.')) || 0;
            const kmPorLitro = parseFloat(document.getElementById('kmPorLitro').value) || 0;
            const valorCombustivel = parseFloat(document.getElementById('valorCombustivel').value) || 0;
            
            let totalLitros = 0;
            let totalCombustivelValor = 0;
            
            if (kmPorLitro > 0) {
                totalLitros = totalKm / kmPorLitro;
                totalCombustivelValor = totalLitros * valorCombustivel;
            }
            
            // Atualizar display
            document.getElementById('totalLitros').textContent = `${totalLitros.toFixed(2)} L`;
            document.getElementById('totalCombustivel').textContent = `R$ ${totalCombustivelValor.toFixed(2).replace('.', ',')}`;
            document.getElementById('resumoTotalCombustivel').textContent = `R$ ${totalCombustivelValor.toFixed(2).replace('.', ',')}`;
            
            // Calcular total geral incluindo combust√≠vel
            const totalMetroBus = parseFloat(document.getElementById('totalMetroBus').textContent.replace('R$ ', '').replace(',', '.')) || 0;
            const totalAlmoco = parseFloat(document.getElementById('totalAlmoco').textContent.replace('R$ ', '').replace(',', '.')) || 0;
            const totalDespesasZonal = parseFloat(document.getElementById('totalDespesasZonal').textContent.replace('R$ ', '').replace(',', '.')) || 0;
            
            const totalGeralSemana = totalCombustivelValor + totalMetroBus + totalAlmoco + totalDespesasZonal;
            
            document.getElementById('totalGeralSemana').textContent = `R$ ${totalGeralSemana.toFixed(2).replace('.', ',')}`;
            
            // Calcular m√©dia por dia
            const numSemanas = document.querySelectorAll('.semana').length;
            const mediaDia = numSemanas > 0 ? totalGeralSemana / (numSemanas * 7) : 0;
            document.getElementById('mediaDia').textContent = `R$ ${mediaDia.toFixed(2).replace('.', ',')}`;
        }

        function salvarExcel() {
            const wb = XLSX.utils.book_new();
            const semanas = document.querySelectorAll('.semana');
            
            // Adicionar dados de cada semana
            semanas.forEach((semana, idx) => {
                const semanaId = semana.id.split('-')[1];
                const dataInicio = semana.querySelector('.data-inicio').value;
                const dataFim = semana.querySelector('.data-fim').value;
                const periodoSemana = dataInicio && dataFim ? 
                    `${formatarData(dataInicio)} a ${formatarData(dataFim)}` : 
                    `Semana ${semanaId}`;
                
                const dados = [];
                
                // T√≠tulo da semana
                dados.push([periodoSemana]);
                dados.push([]);
                
                // Cabe√ßalho
                dados.push(['Dia', 'Local 1', 'M/B 1', 'KM 1', 'Local 2', 'M/B 2', 'KM 2', 'Local 3', 'M/B 3', 'KM 3', 'Almo√ßo', 'Z.Azul', 'Despesas', 'Total']);
                
                // Dados dos dias
                diasSemana.forEach((dia, diaIdx) => {
                    const inputs = semana.querySelectorAll(`input[data-dia="${diaIdx}"]`);
                    const local1 = inputs[0]?.value || '';
                    const mb1 = parseFloat(inputs[1]?.value) || 0;
                    const km1 = parseFloat(inputs[2]?.value) || 0;
                    const local2 = inputs[3]?.value || '';
                    const mb2 = parseFloat(inputs[4]?.value) || 0;
                    const km2 = parseFloat(inputs[5]?.value) || 0;
                    const local3 = inputs[6]?.value || '';
                    const mb3 = parseFloat(inputs[7]?.value) || 0;
                    const km3 = parseFloat(inputs[8]?.value) || 0;
                    const almoco = parseFloat(inputs[9]?.value) || 0;
                    const zonal = parseFloat(inputs[10]?.value) || 0;
                    const desp = parseFloat(inputs[11]?.value) || 0;
                    const totalDia = mb1 + mb2 + mb3 + almoco + zonal + desp;
                    
                    dados.push([dia, local1, mb1, km1, local2, mb2, km2, local3, mb3, km3, almoco, zonal, desp, totalDia]);
                });
                
                // Linha de totais
                const totalMb1 = parseFloat(document.getElementById(`total-mb1-${semanaId}`)?.textContent.replace('R$ ', '').replace(',', '.')) || 0;
                const totalKm1 = parseFloat(document.getElementById(`total-km1-${semanaId}`)?.textContent.replace(' km', '').replace(',', '.')) || 0;
                const totalMb2 = parseFloat(document.getElementById(`total-mb2-${semanaId}`)?.textContent.replace('R$ ', '').replace(',', '.')) || 0;
                const totalKm2 = parseFloat(document.getElementById(`total-km2-${semanaId}`)?.textContent.replace(' km', '').replace(',', '.')) || 0;
                const totalMb3 = parseFloat(document.getElementById(`total-mb3-${semanaId}`)?.textContent.replace('R$ ', '').replace(',', '.')) || 0;
                const totalKm3 = parseFloat(document.getElementById(`total-km3-${semanaId}`)?.textContent.replace(' km', '').replace(',', '.')) || 0;
                const totalAlmoco = parseFloat(document.getElementById(`total-almoco-${semanaId}`)?.textContent.replace('R$ ', '').replace(',', '.')) || 0;
                const totalZonal = parseFloat(document.getElementById(`total-zonal-${semanaId}`)?.textContent.replace('R$ ', '').replace(',', '.')) || 0;
                const totalDesp = parseFloat(document.getElementById(`total-desp-${semanaId}`)?.textContent.replace('R$ ', '').replace(',', '.')) || 0;
                const totalSemana = totalMb1 + totalMb2 + totalMb3 + totalAlmoco + totalZonal + totalDesp;
                
                dados.push(['TOTAL', '-', totalMb1, totalKm1 + ' km', '-', totalMb2, totalKm2 + ' km', '-', totalMb3, totalKm3 + ' km', totalAlmoco, totalZonal, totalDesp, totalSemana]);
                
                const ws = XLSX.utils.aoa_to_sheet(dados);
                XLSX.utils.book_append_sheet(wb, ws, periodoSemana.substring(0, 31));
            });
            
            // Adicionar planilha de resumo
            const resumoDados = [];
            resumoDados.push(['RESUMO GERAL DE DESPESAS']);
            resumoDados.push([]);
            resumoDados.push(['C√ÅLCULO DE COMBUST√çVEL']);
            resumoDados.push(['Total KM:', document.getElementById('totalKmGeral').textContent]);
            resumoDados.push(['KM/Litro:', document.getElementById('kmPorLitro').value || 0]);
            resumoDados.push(['Valor Combust√≠vel (R$/L):', document.getElementById('valorCombustivel').value || 0]);
            resumoDados.push(['Total em Litros:', document.getElementById('totalLitros').textContent]);
            resumoDados.push(['Total Combust√≠vel:', document.getElementById('totalCombustivel').textContent]);
            resumoDados.push([]);
            resumoDados.push(['OUTRAS DESPESAS']);
            resumoDados.push(['Total Metr√¥/Bus:', document.getElementById('totalMetroBus').textContent]);
            resumoDados.push(['Total Almo√ßo:', document.getElementById('totalAlmoco').textContent]);
            resumoDados.push(['Despesas + Zona Azul:', document.getElementById('totalDespesasZonal').textContent]);
            resumoDados.push([]);
            resumoDados.push(['TOTAL GERAL DE DESPESAS NA SEMANA:', document.getElementById('totalGeralSemana').textContent]);
            resumoDados.push(['M√©dia por Dia:', document.getElementById('mediaDia').textContent]);
            resumoDados.push(['Total de Semanas:', document.getElementById('totalSemanas').textContent]);
            
            const wsResumo = XLSX.utils.aoa_to_sheet(resumoDados);
            XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo Geral');
            
            XLSX.writeFile(wb, 'Planilha_Despesas_Completa.xlsx');
        }

        // Carregar dados ao iniciar
        window.addEventListener('DOMContentLoaded', carregarDados);
    </script>
</body>
</html>

